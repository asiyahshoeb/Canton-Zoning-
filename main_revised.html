<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canton Zoning & Building Code Analysis</title>
    <style>
        /* [Existing CSS remains unchanged for brevity] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            min-height: 100vh;
            padding: 20px;
            color: #212529;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .header p {
            font-size: 1rem;
            color: #6c757d;
            max-width: 600px;
            margin: 0 auto;
        }

        .township-name {
            color: #dc3545;
            font-weight: 600;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }

        .input-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.4rem;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95rem;
        }

        .required {
            color: #dc3545;
            margin-left: 4px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 0.95rem;
            background: #ffffff;
            color: #495057;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        input::placeholder {
            color: #6c757d;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .btn {
            background: #007bff;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            margin-top: 15px;
            font-family: inherit;
        }

        .btn:hover:not(:disabled) {
            background: #0056b3;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #545b62;
        }

        .ai-assistant {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .ai-assistant h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .chat-container {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 14px 16px;
            border-radius: 10px;
            animation: slideIn 0.3s ease;
            line-height: 1.6;
            white-space: pre-line;
        }

        .user-message {
            background: #007bff;
            margin-left: 40px;
            color: white;
        }

        .ai-message {
            background: #ffffff;
            margin-right: 20px;
            border: 1px solid #dee2e6;
            border-left: 5px solid #007bff;
        }

        .chat-input {
            display: flex;
            gap: 12px;
        }

        .chat-input input {
            flex: 1;
            margin: 0;
        }

        .chat-input button {
            width: auto;
            padding: 12px 20px;
            margin: 0;
        }

        .results {
            display: none;
            animation: fadeIn 0.6s ease;
            grid-column: 1 / -1;
        }

        .results.show {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .result-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .result-section h3 {
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .info-row {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .info-row strong {
            display: block;
            color: #495057;
            font-size: 0.8rem;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .info-row .value {
            color: #212529;
            font-size: 1rem;
            font-weight: 500;
        }

        .info-row .value a {
            color: #007bff;
            text-decoration: none;
        }

        .info-row .value a:hover {
            text-decoration: underline;
        }

        .zone-description {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #1565c0;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #f5c6cb;
            font-size: 0.9rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #c3e6cb;
            font-size: 0.9rem;
        }

        .restrictions-section {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-top: 20px;
            border-radius: 6px;
        }

        .restrictions-section h4 {
            color: #856404;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .restrictions-section ul {
            margin-left: 20px;
            color: #856404;
            line-height: 1.8;
        }

        .wetland-overlay {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 20px;
            margin-top: 20px;
            border-radius: 6px;
        }

        .wetland-overlay h4 {
            color: #0c5460;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .wetland-overlay p {
            color: #0c5460;
            line-height: 1.8;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @media print {
            .input-section, .ai-assistant, .btn { display: none; }
            .results { display: block !important; }
            .main-grid, .results-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }

            .ai-assistant {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="township-name">Canton</span> Zoning Analysis</h1>
            <p>Professional zoning and building code analysis tool for architects and developers working in Canton, Wayne County, Michigan.</p>
        </div>

        <div class="main-grid">
            <div class="input-section">
                <div class="card">
                    <h2>Property Analysis Input</h2>
                    
                    <div class="input-group">
                        <label for="address">Property Address<span class="required">*</span></label>
                        <input 
                            type="text" 
                            id="address" 
                            placeholder="Enter any property address (e.g., 1150 Canton Center Rd)"
                            required
                        >
                        <div id="addressError" class="error-message" style="display: none;"></div>
                        <div id="addressSuccess" class="success-message" style="display: none;"></div>
                    </div>

                    <div class="input-group">
                        <label for="zoningDistrict">Zoning District<span class="required">*</span></label>
                        <select id="zoningDistrict" required>
                            <option value="">Select Zoning District</option>
                            <option value="RA">RA - Rural Agricultural</option>
                            <option value="RR">RR - Rural Residential</option>
                            <option value="RE">RE - Residential Estate</option>
                            <option value="R-1">R-1 - Single Family Residential (lowest density)</option>
                            <option value="R-2">R-2 - Single Family Residential (medium density)</option>
                            <option value="R-3">R-3 - Single Family Residential (higher density)</option>
                            <option value="R-4">R-4 - High Density Residential</option>
                            <option value="C-1">C-1 - Local Business</option>
                            <option value="C-2">C-2 - General Business</option>
                            <option value="C-3">C-3 - Regional Commercial</option>
                            <option value="I-1">I-1 - Light Industrial</option>
                            <option value="I-2">I-2 - General Industrial</option>
                            <option value="PUD">PUD - Planned Unit Development</option>
                        </select>
                        <div id="zoneDescription" class="zone-description" style="display: none;"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="lotWidth">Lot Width (feet)</label>
                        <input 
                            type="number" 
                            id="lotWidth" 
                            placeholder="e.g., 80"
                        >
                        <div class="optional-hint" style="font-size: 0.8rem; color: #6c757d; margin-top: 4px;">
                            Optional - for buildable area visualization.
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="lotDepth">Lot Depth (feet)</label>
                        <input 
                            type="number" 
                            id="lotDepth" 
                            placeholder="e.g., 120"
                        >
                        <div class="optional-hint" style="font-size: 0.8rem; color: #6c757d; margin-top: 4px;">
                            Optional - for buildable area visualization.
                        </div>
                    </div>


                    <button class="btn" onclick="analyzeProperty()">Generate Zoning Analysis</button>
                    <button class="btn btn-secondary" onclick="window.print()" style="display: none;" id="printBtn">Print Report</button>
                </div>
            </div>

            <div class="ai-assistant">
                <div class="card">
                    <h3>Zoning Code Assistant</h3>
                    <div class="chat-container" id="chatContainer">
                        <div class="ai-message">
                            I can help answer questions about Canton zoning requirements. Analyze a property to get started, then ask me about setbacks, height restrictions, lot coverage, parking requirements, garage placement, wetland regulations, or any other zoning matters.
                        </div>
                    </div>
                    <div class="chat-input">
                        <input 
                            type="text" 
                            id="chatInput" 
                            placeholder="Ask about zoning requirements..."
                        >
                        <button class="btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <div class="results-grid">
                <div class="card">
                    <div class="result-section">
                        <h3>Property Information</h3>
                        <div class="info-grid">
                            <div class="info-row">
                                <strong>Address</strong>
                                <div class="value" id="res-address">-</div>
                            </div>
                            <div class="info-row">
                                <strong>Municipality</strong>
                                <div class="value"><span class="township-name">Canton</span>, Wayne County, Michigan</div>
                            </div>
                        </div>
                    </div>

                    <div class="result-section">
                        <h3>Zoning Classification</h3>
                        <div class="info-grid">
                            <div class="info-row">
                                <strong>Zoning District</strong>
                                <div class="value" id="res-zoning-district">-</div>
                            </div>
                            <div class="info-row">
                                <strong>District Name</strong>
                                <div class="value" id="res-district-desc">-</div>
                            </div>
                            <div class="info-row">
                                <strong>Official Reference</strong>
                                <div class="value">
                                    <a href="https://library.municode.com/mi/canton_charter_township,_(wayne_co.)/codes/code_of_ordinances?nodeId=PTIILADERE_APXAZO" target="_blank">Canton Zoning Ordinance</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="result-section" id="lot-requirements">
                        <h3>Lot Requirements</h3>
                        <div class="info-grid">
                            <div class="info-row" id="min-lot-area-row" style="display: none;">
                                <strong>Minimum Lot Area</strong>
                                <div class="value" id="res-min-lot-area">-</div>
                            </div>
                            <div class="info-row" id="min-lot-width-row" style="display: none;">
                                <strong>Minimum Lot Width</strong>
                                <div class="value" id="res-min-lot-width">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="result-section">
                        <h3>Required Setbacks</h3>
                        <div class="info-grid">
                            <div class="info-row">
                                <strong>Front Setback</strong>
                                <div class="value" id="res-front-setback">-</div>
                            </div>
                            <div class="info-row">
                                <strong>Rear Setback</strong>
                                <div class="value" id="res-rear-setback">-</div>
                            </div>
                            <div class="info-row">
                                <strong>Side Setback (Each)</strong>
                                <div class="value" id="res-side-setback">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="result-section">
                        <h3>Development Standards</h3>
                        <div class="info-grid">
                            <div class="info-row">
                                <strong>Maximum Height</strong>
                                <div class="value" id="res-max-height">-</div>
                            </div>
                            <div class="info-row">
                                <strong>Maximum Lot Coverage</strong>
                                <div class="value" id="res-lot-coverage">-</div>
                            </div>
                            <div class="info-row">
                                <strong>Floor Area Ratio (FAR)</strong>
                                <div class="value" id="res-far">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="restrictions-section">
                        <h4>🏗️ Specific Design Restrictions</h4>
                        <ul id="restrictions-list">
                        </ul>
                    </div>

                    <div class="wetland-overlay" id="wetlandOverlay" style="display: none;">
                        <h4>💧 Wetland Overlay District</h4>
                        <p id="wetland-info"></p>
                    </div>
                </div>
            </div>
            <!-- ########## MAP CONTAINER ELEMENT ########## -->
            <div id="map" style="height: 400px; width: 100%; border-radius: 8px; margin-top: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></div>
        </div>

        <!--

        <script async
            src=
        </script>
        
        <script>
            // Global variables for map and marker
            let map;
            let marker;
            let propertyRectangle;
            let buildableAreaRectangle;

            function initMap() {
                // Set a more relevant default location
                const cantonMI = { lat: 42.3086, lng: -83.4822 };

                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 12,
                    center: cantonMI,
                });

                marker = new google.maps.Marker({
                    position: cantonMI,
                    map: map,
                    title: "Canton, MI"
                });
            }

            function drawRectangles(center, lotWidth, lotDepth, setbacks) {
                // Clear existing rectangles
                if (propertyRectangle) propertyRectangle.setMap(null);
                if (buildableAreaRectangle) buildableAreaRectangle.setMap(null);

                // Constants for conversion
                const FEET_TO_METERS = 0.3048;
                const METERS_PER_DEGREE_LAT = 111132;

                // Calculate latitude and longitude offsets
                const latOffset = (lotDepth * FEET_TO_METERS) / METERS_PER_DEGREE_LAT / 2;
                const lngOffset = (lotWidth * FEET_TO_METERS) / (METERS_PER_DEGREE_LAT * Math.cos(center.lat() * Math.PI / 180)) / 2;

                // 1. Draw Property Outline
                const propertyBounds = {
                    north: center.lat() + latOffset,
                    south: center.lat() - latOffset,
                    east: center.lng() + lngOffset,
                    west: center.lng() - lngOffset,
                };

                propertyRectangle = new google.maps.Rectangle({
                    strokeColor: "#007bff",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#007bff",
                    fillOpacity: 0.1,
                    map,
                    bounds: propertyBounds,
                });

                // 2. Draw Buildable Area
                const buildableLatOffset = ((lotDepth - setbacks.front - setbacks.rear) * FEET_TO_METERS) / METERS_PER_DEGREE_LAT / 2;
                const buildableLngOffset = ((lotWidth - (setbacks.side * 2)) * FEET_TO_METERS) / (METERS_PER_DEGREE_LAT * Math.cos(center.lat() * Math.PI / 180)) / 2;

                const buildableBounds = {
                    north: center.lat() + buildableLatOffset,
                    south: center.lat() - buildableLatOffset,
                    east: center.lng() + buildableLngOffset,
                    west: center.lng() - buildableLngOffset,
                };

                buildableAreaRectangle = new google.maps.Rectangle({
                    strokeColor: "#dc3545",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#dc3545",
                    fillOpacity: 0.35,
                    map,
                    bounds: buildableBounds,
                });

                map.fitBounds(propertyBounds); // Adjust map to fit the property
            }

            function geocodeAddressAndUpdateMap(address, lotWidth, lotDepth, setbacks) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': address }, function(results, status) {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        map.setCenter(location);
                        marker.setPosition(location);
                        marker.setTitle(address);

                        if (lotWidth && lotDepth && setbacks) {
                            drawRectangles(location, lotWidth, lotDepth, setbacks);
                        } else {
                            map.setZoom(17);
                        }
                    } else {
                        alert('Geocode was not successful for the following reason: ' + status);
                    }
                });
            }
        </script>

        ########## END OF GOOGLE MAPS API & FUNCTIONS ########## -->
        
    </div>

    <script>
        const zoningDescriptions = {
            'RA': 'Rural Agricultural district intended to preserve agricultural uses and low-density rural development.',
            'RR': 'Rural Residential district for low-density residential development in rural settings with larger lots.',
            'RE': 'Residential Estate district for large lot single-family homes in estate-like settings.',
            'R-1': 'Single-family residential district with lowest density requirements and larger lots.',
            'R-2': 'Single-family residential district with medium density allowing smaller lot sizes.',
            'R-3': 'Single-family residential district with higher density and more compact development.',
            'R-4': 'High-density residential district for apartment complexes and high-rise residential buildings.',
            'C-1': 'Local business district for neighborhood commercial services.',
            'C-2': 'General business district for retail, office, and service establishments.',
            'C-3': 'Regional commercial district for large-scale retail and entertainment facilities.',
            'I-1': 'Light industrial district for manufacturing and warehouse uses with minimal environmental impact.',
            'I-2': 'General industrial district for heavy manufacturing and industrial operations.',
            'PUD': 'Planned Unit Development allowing flexible design standards through special approval process.'
        };

        const cantonOrdinanceDB = {
            zoning: {
                'RA': {
                    minLotArea: '43,560 sq ft (1 acre)',
                    minLotWidth: '150 ft',
                    setbacks: { front: 50, rear: 50, side: 15 },
                    maxHeight: '35 feet',
                    maxCoverage: '25%',
                    far: '0.25',
                    restrictions: [
                        'Agricultural uses permitted including farming, forestry, and livestock',
                        'One single-family dwelling per lot maximum',
                        'Minimum 50-foot setback from all property lines for agricultural buildings',
                        'Home occupations permitted with agricultural focus',
                        'Accessory structures limited to 20 feet in height',
                        'Well and septic systems typically required',
                        'Conservation of natural features encouraged'
                    ]
                },
                'RR': {
                    minLotArea: '20,000 sq ft',
                    minLotWidth: '125 ft',
                    setbacks: { front: 45, rear: 50, side: 15 },
                    maxHeight: '35 feet',
                    maxCoverage: '30%',
                    far: '0.35',
                    restrictions: [
                        'Single-family residential use only',
                        'Minimum dwelling size: 1,800 sq ft',
                        'Garages must be set back minimum 25 feet from front property line',
                        'Private wells and septic systems may be required',
                        'Accessory structures limited to 18 feet in height',
                        'Natural vegetation preservation encouraged',
                        'Home occupations permitted with restrictions'
                    ]
                },
                'RE': {
                    minLotArea: '15,000 sq ft',
                    minLotWidth: '120 ft',
                    setbacks: { front: 45, rear: 50, side: 15 },
                    maxHeight: '35 feet',
                    maxCoverage: '30%',
                    far: '0.40',
                    restrictions: [
                        'Single-family residential use only',
                        'Minimum dwelling size: 1,600 sq ft',
                        'Garages must be set back minimum 23 feet from front property line',
                        'Side-load garages encouraged for estate character',
                        'Accessory structures limited to 18 feet in height',
                        'Minimum 3-car garage encouraged',
                        'Landscaping requirements more stringent than standard residential'
                    ]
                },
                'R-1': {
                    minLotArea: '12,000 sq ft',
                    minLotWidth: '110 ft',
                    setbacks: { front: 40, rear: 50, side: 15 },
                    maxHeight: '35 feet',
                    maxCoverage: '35%',
                    far: '0.50',
                    restrictions: [
                        'Single-family residential use only',
                        'Minimum dwelling size: 1,400 sq ft',
                        'Garages must be set back minimum 20 feet from front property line',
                        'Garage doors facing the street require additional 5-foot setback beyond principal structure',
                        'Accessory structures limited to 15 feet in height',
                        'Fences in front yard limited to 4 feet in height',
                        'Minimum 2-car garage required for new construction'
                    ]
                },
                'R-2': {
                    minLotArea: '10,000 sq ft',
                    minLotWidth: '100 ft',
                    setbacks: { front: 40, rear: 50, side: 15 },
                    maxHeight: '35 feet',
                    maxCoverage: '35%',
                    far: '0.60',
                    restrictions: [
                        'Single-family residential use only',
                        'Minimum dwelling size: 1,200 sq ft',
                        'Garages must be set back minimum 18 feet from front property line',
                        'Side-load or rear-load garages preferred',
                        'Accessory structures limited to 15 feet in height',
                        'Front porches encouraged, may project into setback up to 6 feet',
                        'Minimum 2-car garage required'
                    ]
                },
                'R-3': {
                    minLotArea: '8,000 sq ft',
                    minLotWidth: '80 ft',
                    setbacks: { front: 35, rear: 50, side: 10 },
                    maxHeight: '35 feet',
                    maxCoverage: '35%',
                    far: '0.70',
                    restrictions: [
                        'Single-family residential use only',
                        'Minimum dwelling size: 1,000 sq ft',
                        'Garages must be set back minimum 15 feet from front property line',
                        'Side-load garages strongly encouraged',
                        'Accessory structures limited to 15 feet in height',
                        'Front porches encouraged, may project into setback up to 6 feet',
                        'Minimum 2-car garage required'
                    ]
                },
                'R-4': {
                    setbacks: { front: 15, rear: 15, side: 12 },
                    maxHeight: '60 feet (5 stories)',
                    maxCoverage: '60%',
                    far: '2.00',
                    restrictions: [
                        'Structured parking required for buildings over 3 stories',
                        'Ground floor uses may include limited commercial (max 10% of GFA)',
                        'Building facades over 100 feet require articulation every 40 feet',
                        'Minimum 15% of site must be landscaped open space',
                        'Parking lots must include landscape islands every 10 spaces',
                        'Loading areas must be screened and not face residential districts'
                    ]
                },
                'C-1': {
                    setbacks: { front: 10, rear: 10, side: 5 },
                    maxHeight: '35 feet (2 stories)',
                    maxCoverage: '70%',
                    far: '1.50',
                    restrictions: [
                        'Building must be oriented to street with primary entrance visible',
                        'Parking prohibited between building and street',
                        'Drive-through facilities require special land use permit',
                        'Outdoor storage prohibited in front yard',
                        'Screening required along residential district boundaries',
                        'Signage limited to 1 sq ft per linear foot of building frontage'
                    ]
                },
                'C-2': {
                    setbacks: { front: 10, rear: 10, side: 5 },
                    maxHeight: '45 feet (3 stories)',
                    maxCoverage: '75%',
                    far: '2.00',
                    restrictions: [
                        'Principal buildings must occupy minimum 40% of lot frontage',
                        'Loading docks must be screened from public rights-of-way',
                        'Outdoor dining requires 6-foot minimum clear pedestrian path',
                        'Vehicle stacking for drive-throughs: 5 vehicles minimum',
                        'Canopies over gas pumps excluded from height calculation',
                        'Monument signs only; pole signs prohibited'
                    ]
                },
                'C-3': {
                    setbacks: { front: 15, rear: 15, side: 10 },
                    maxHeight: '60 feet (4 stories)',
                    maxCoverage: '80%',
                    far: '3.00',
                    restrictions: [
                        'Site plan review required for all developments',
                        'Traffic impact study required for projects generating 1,000+ daily trips',
                        'Parking lots over 100 spaces require internal landscape islands',
                        'Building materials: minimum 60% brick, stone, or cultured stone on street-facing facades',
                        'Rooftop equipment must be screened from view at property lines',
                        'Pedestrian connections required to adjacent properties'
                    ]
                },
                'I-1': {
                    setbacks: { front: 20, rear: 20, side: 15 },
                    maxHeight: '45 feet',
                    maxCoverage: '60%',
                    far: '1.50',
                    restrictions: [
                        'Outdoor storage must be screened with 6-foot opaque fence or wall',
                        'Loading docks prohibited within 50 feet of residential districts',
                        'Hours of operation may be restricted near residential areas',
                        'Noise levels at property line: 60 dB daytime, 55 dB nighttime',
                        'All parking and drive areas must be hard-surfaced',
                        'Stormwater detention required for all developments'
                    ]
                },
                'I-2': {
                    setbacks: { front: 25, rear: 25, side: 20 },
                    maxHeight: '60 feet',
                    maxCoverage: '70%',
                    far: '2.50',
                    restrictions: [
                        'Hazardous materials require special permits and reporting',
                        '100-foot buffer required from residential districts',
                        'External lighting must not exceed 0.5 footcandles at property lines',
                        'Truck traffic restricted to designated routes',
                        'All outdoor operations require screening and setback compliance',
                        'Environmental impact assessment required for heavy manufacturing'
                    ]
                },
                'PUD': {
                    setbacks: { front: 'Variable', rear: 'Variable', side: 'Variable' },
                    maxHeight: 'Per approval',
                    maxCoverage: 'Per approval',
                    far: 'Per approval',
                    restrictions: [
                        'Minimum 5-acre site required for PUD application',
                        'Master plan must demonstrate superior design and public benefits',
                        'Minimum 25% open space required',
                        'Mix of uses encouraged in appropriate locations',
                        'Traffic circulation must be approved by township engineer',
                        'Architectural standards established during approval process',
                        'Public hearings required before Planning Commission and Board of Trustees'
                    ]
                }
            }
        };

        let currentProperty = null;
        let currentZoning = null;

        document.getElementById('zoningDistrict').addEventListener('change', function() {
            const selectedZone = this.value;
            const descElement = document.getElementById('zoneDescription');
            
            if (selectedZone && zoningDescriptions[selectedZone]) {
                descElement.textContent = zoningDescriptions[selectedZone];
                descElement.style.display = 'block';
            } else {
                descElement.style.display = 'none';
            }
        });

        function validateAddress(address) {
            const addr = address.trim();
            const errorElement = document.getElementById('addressError');
            const successElement = document.getElementById('addressSuccess');
            
            if (!addr) {
                errorElement.textContent = 'Property Address is required.';
                errorElement.style.display = 'block';
                successElement.style.display = 'none';
                return false;
            } else {
                errorElement.style.display = 'none';
                successElement.textContent = 'Address accepted. (Note: True address verification requires an external database lookup)';
                successElement.style.display = 'block';
                return true;
            }
        }

        // --- Core Logic: Analyze Property ---
        function analyzeProperty() {
            const addressInput = document.getElementById('address');
            const zoningSelect = document.getElementById('zoningDistrict');
            const address = addressInput.value;
            const zoneCode = zoningSelect.value;
            const lotWidth = parseFloat(document.getElementById('lotWidth').value);
            const lotDepth = parseFloat(document.getElementById('lotDepth').value);
            const resultsDiv = document.getElementById('results');
            
            // 1. Validation
            const isAddressValid = validateAddress(address);
            if (!isAddressValid || !zoneCode) {
                alert('Please enter a property address and select a zoning district.');
                resultsDiv.classList.remove('show');
                return;
            }

            // 2. Data Retrieval first to get setbacks
            const zoneData = cantonOrdinanceDB.zoning[zoneCode];
            
            // 3. NOW Geocode the address and update the map, passing dimensions and setbacks
            geocodeAddressAndUpdateMap(address, lotWidth, lotDepth, zoneData.setbacks);

            currentZoning = { ...zoneData, zoneCode }; // Store zoneCode within currentZoning
            currentProperty = { address, zoneCode, zoneName: zoningSelect.options[zoningSelect.selectedIndex].text.split(' - ')[1].trim() };
            
            // 4. Populate Results
            
            // A. Property Info
            document.getElementById('res-address').textContent = address;
            document.getElementById('res-zoning-district').textContent = zoneCode;
            document.getElementById('res-district-desc').textContent = currentProperty.zoneName;

            // B. Lot Requirements (Conditional Display)
            const hasLotRequirements = zoneData.minLotArea || zoneData.minLotWidth;
            document.getElementById('lot-requirements').style.display = hasLotRequirements ? 'block' : 'none';
            if (hasLotRequirements) {
                document.getElementById('min-lot-area-row').style.display = zoneData.minLotArea ? 'block' : 'none';
                document.getElementById('res-min-lot-area').textContent = zoneData.minLotArea || 'N/A';
                document.getElementById('min-lot-width-row').style.display = zoneData.minLotWidth ? 'block' : 'none';
                document.getElementById('res-min-lot-width').textContent = zoneData.minLotWidth || 'N/A';
            }

            // C. Setbacks
            document.getElementById('res-front-setback').textContent = `${zoneData.setbacks.front}`;
            document.getElementById('res-rear-setback').textContent = `${zoneData.setbacks.rear}`;
            document.getElementById('res-side-setback').textContent = `${zoneData.setbacks.side}`;

            // D. Development Standards
            document.getElementById('res-max-height').textContent = zoneData.maxHeight;
            document.getElementById('res-lot-coverage').textContent = zoneData.maxCoverage;
            document.getElementById('res-far').textContent = zoneData.far;

            // E. Restrictions List
            const restrictionsList = document.getElementById('restrictions-list');
            restrictionsList.innerHTML = '';
            zoneData.restrictions.forEach(restriction => {
                const li = document.createElement('li');
                li.textContent = restriction;
                restrictionsList.appendChild(li);
            });
            
            // F. Wetland Overlay Mock (Example check)
            const wetlandOverlay = document.getElementById('wetlandOverlay');
            if (address.toLowerCase().includes('haggerty') || zoneCode === 'RA') {
                wetlandOverlay.style.display = 'block';
                document.getElementById('wetland-info').textContent = 'The property is likely within the Regulated Wetland Overlay District. A State/Township permit is required for any earth change or construction activity near delineated wetlands. Refer to Canton Ordinance, Article 36.';
            } else {
                wetlandOverlay.style.display = 'none';
            }

            // 5. Show Results and Print Button
            resultsDiv.classList.add('show');
            document.getElementById('printBtn').style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // --- Chat Assistant Logic ---
        function appendMessage(sender, message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(`${sender}-message`);
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll to bottom
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;

            // Display user message
            appendMessage('user', message);
            chatInput.value = '';

            // Simulate AI response
            setTimeout(() => {
                const aiResponse = getAssistantResponse(message);
                appendMessage('ai', aiResponse);
            }, 800);
        }

        function getAssistantResponse(message) {
            const lowMessage = message.toLowerCase();
            
            if (!currentZoning) {
                return "I need a zoning district selected and the 'Generate Zoning Analysis' button clicked before I can provide specific guidance for a property.";
            }

            if (lowMessage.includes('setback') || lowMessage.includes('yard')) {
                const { front, rear, side } = currentZoning.setbacks;
                return `For the ${currentProperty.zoneCode} district, the minimum required setbacks are:\n- **Front:** ${front}\n- **Rear:** ${rear}\n- **Side (each):** ${side}\n\nThese values are typically in feet. Always check for specific corner lot or accessory building rules in the full ordinance.`;
            }

            if (lowMessage.includes('height') || lowMessage.includes('stories')) {
                return `The maximum building height in the **${currentProperty.zoneCode}** district is **${currentZoning.maxHeight}**. This applies to principal structures. Accessory structures often have lower limits (e.g., 15-20 feet).`;
            }

            if (lowMessage.includes('lot coverage') || lowMessage.includes('impervious')) {
                return `The maximum lot coverage (the total area of all buildings and paved surfaces) for the **${currentProperty.zoneCode}** district is **${currentZoning.maxCoverage}**.`;
            }

            if (lowMessage.includes('parking')) {
                let parkingText = '';
                if (currentProperty.zoneCode.startsWith('R')) {
                    parkingText = "Residential districts typically require a minimum of two (2) parking spaces per dwelling unit, usually in a garage or driveway. Street parking is regulated.";
                } else if (currentProperty.zoneCode.startsWith('C')) {
                    parkingText = "Commercial parking requirements vary by use (e.g., 1 space per 200 sq ft of retail, 1 per 300 sq ft of office). Landscaping and screening are required for all commercial lots.";
                } else {
                    parkingText = "For this district, required parking must be calculated based on the specific use (e.g., floor area, number of employees). Consult Article 20 of the Zoning Ordinance.";
                }
                return parkingText;
            }

            if (lowMessage.includes('wetland') || lowMessage.includes('environmental')) {
                return "Canton Township has a Wetland Protection Ordinance (Article 36) that regulates development near delineated wetlands, watercourses, and floodplains. A permit is usually required for any earth change within a defined setback (often 25-50 feet) of these features.";
            }

            if (lowMessage.includes('thank') || lowMessage.includes('hello')) {
                return "You're welcome! Feel free to ask another specific question about the zoning requirements for the property you've analyzed.";
            }

            return `I'm an AI assistant focused on providing specific data from the Canton zoning code for the **${currentProperty.zoneCode}** district. Try asking about a specific topic like "Front Setback," "Maximum Height," or "Parking Requirements."`;
        }

        // Add event listener for Enter key in chat input
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
